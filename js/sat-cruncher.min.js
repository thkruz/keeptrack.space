importScripts("lib/satellite.js");var satPos,satVel,satInView,TAU=2*Math.PI,DEG2RAD=TAU/360,RAD2DEG=360/TAU,RADIUS_OF_EARTH=6371,globalPropagationRate=1e3,globalPropagationRateMultiplier=1,satCache=[],sensorMarkerArray=[0],satelliteSelected=[-1],selectedSatFOV=90,isShowFOVBubble=!1,isShowSurvFence=!1,isResetFOVBubble=!1,isShowSatOverfly=!1,isResetSatOverfly=!1,isMultiSensor=!1,isIgnoreNonRadar=!0,planetariumView=!1,isLowPerf=!1,sensor={},mSensor={},defaultGd={lat:null,longitude:0,latitude:0,height:0};sensor.defaultGd=defaultGd,sensor.observerGd=defaultGd;var propagationRunning=!1,divisor=1,propOffset=0,propRate=1,propRealTime=Date.now();function _lookAnglesToEcf(e,s,a,t,o,n){var r={};r.latitude=t,r.longitude=o,r.height=n;var i,l,c,m=satellite.geodeticToEcf(r);i=m.x,l=m.y,c=m.z;var b=Math.sin(t),d=Math.sin(o),h=Math.cos(t),g=Math.cos(o),u=DEG2RAD*e,f=DEG2RAD*s,S=-a*Math.cos(f)*Math.cos(u),P=a*Math.cos(f)*Math.sin(u),M=a*Math.sin(f);return{x:b*g*S+-d*P+h*g*M+i,y:b*d*S+g*P+h*d*M+l,z:-h*S+b*M+c}}function propagateCruncher(){propagationRunning=!0;var e=propTime(),s=jday(e.getUTCFullYear(),e.getUTCMonth()+1,e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds());s+=1.15741e-8*e.getUTCMilliseconds();var a=satellite.gstime(s),t=s;t=jday(e.getUTCFullYear(),e.getUTCMonth()+1,e.getUTCDate(),e.getUTCHours(),e.getUTCMinutes(),e.getUTCSeconds()+1),t+=1.15741e-8*e.getUTCMilliseconds();var o=satellite.gstime(t),n=satCache.length-1;(isResetSatOverfly||isShowSatOverfly||isResetFOVBubble||isShowFOVBubble)&&!isLowPerf||(n-=fieldOfViewSetLength);for(var r,i,l,c,m,b,d,h,g,u,f,S,P,M,x,v,V,E,p,G,z,A,D,R,C=-1,T=!1;C<n;){if((p=satCache[++C]).satnum){if(p.skip)continue;if(x=1440*(s-p.jdsatepoch),!1!==(v=satellite.sgp4(p,x))[0]?(satPos[3*C]=v.position.x,satPos[3*C+1]=v.position.y,satPos[3*C+2]=v.position.z,satVel[3*C]=v.velocity.x,satVel[3*C+1]=v.velocity.y,satVel[3*C+2]=v.velocity.z,T||(sensor.observerGd===defaultGd||isMultiSensor?T=!0:(r=satellite.eciToEcf(v.position,a),l=(i=satellite.ecfToLookAngles(sensor.observerGd,r)).azimuth,c=i.elevation,m=i.rangeSat))):(satCache[C].skip=!0,satPos[3*C]=0,satPos[3*C+1]=0,satPos[3*C+2]=0,satVel[3*C]=0,satVel[3*C+1]=0,satVel[3*C+2]=0,r=0,i=0,l=0,c=0,m=0),satInView[C]=!1,sensor.observerGd!==defaultGd)if(isMultiSensor)for(M=0;M<mSensor.length&&!satInView[C];M++)(sensor=mSensor[M]).observerGd={longitude:sensor.long*DEG2RAD,latitude:sensor.lat*DEG2RAD,height:1*sensor.obshei},r=satellite.eciToEcf(v.position,a),l=(i=satellite.ecfToLookAngles(sensor.observerGd,r)).azimuth,c=i.elevation,m=i.rangeSat,l*=RAD2DEG,c*=RAD2DEG,sensor.obsminaz>sensor.obsmaxaz?((l>=sensor.obsminaz||l<=sensor.obsmaxaz)&&c>=sensor.obsminel&&c<=sensor.obsmaxel&&m<=sensor.obsmaxrange&&m>=sensor.obsminrange||(l>=sensor.obsminaz2||l<=sensor.obsmaxaz2)&&c>=sensor.obsminel2&&c<=sensor.obsmaxel2&&m<=sensor.obsmaxrange2&&m>=sensor.obsminrange2)&&(satInView[C]=!0):(l>=sensor.obsminaz&&l<=sensor.obsmaxaz&&c>=sensor.obsminel&&c<=sensor.obsmaxel&&m<=sensor.obsmaxrange&&m>=sensor.obsminrange||l>=sensor.obsminaz2&&l<=sensor.obsmaxaz2&&c>=sensor.obsminel2&&c<=sensor.obsmaxel2&&m<=sensor.obsmaxrange2&&m>=sensor.obsminrange2)&&(satInView[C]=!0);else l*=RAD2DEG,c*=RAD2DEG,sensor.obsminaz>sensor.obsmaxaz?((l>=sensor.obsminaz||l<=sensor.obsmaxaz)&&c>=sensor.obsminel&&c<=sensor.obsmaxel&&m<=sensor.obsmaxrange&&m>=sensor.obsminrange||(l>=sensor.obsminaz2||l<=sensor.obsmaxaz2)&&c>=sensor.obsminel2&&c<=sensor.obsmaxel2&&m<=sensor.obsmaxrange2&&m>=sensor.obsminrange2)&&(satInView[C]=!0):(l>=sensor.obsminaz&&l<=sensor.obsmaxaz&&c>=sensor.obsminel&&c<=sensor.obsmaxel&&m<=sensor.obsmaxrange&&m>=sensor.obsminrange||l>=sensor.obsminaz2&&l<=sensor.obsmaxaz2&&c>=sensor.obsminel2&&c<=sensor.obsmaxel2&&m<=sensor.obsmaxrange2&&m>=sensor.obsminrange2)&&(satInView[C]=!0)}else if(satCache[C].static&&!satCache[C].marker){if("Star"==satCache[C].type){var w=StarCalc.getStarPosition(e,180,0,satCache[C]);w=_lookAnglesToEcf(w.azimuth*RAD2DEG,w.altitude*RAD2DEG,2e5,0,0,0),(0==satPos[3*C]||satPos[3*C]-w.x<.1&&satPos[3*C]-w.x>-.1)&&(satPos[3*C]=w.x),(0==satPos[3*C+1]||satPos[3*C+1]-w.y<.1&&satPos[3*C+1]-w.y>-.1)&&(satPos[3*C+1]=w.y),(0==satPos[3*C+2]||satPos[3*C+2]-w.z<.1&&satPos[3*C+2]-w.z>-.1)&&(satPos[3*C+2]=w.z)}else g=Math.cos(satCache[C].lat*DEG2RAD),u=Math.sin(satCache[C].lat*DEG2RAD),f=Math.cos(satCache[C].lon*DEG2RAD+a),S=Math.sin(satCache[C].lon*DEG2RAD+a),satPos[3*C]=(6371.25+satCache[C].alt)*g*f,satPos[3*C+1]=(6371.25+satCache[C].alt)*g*S,satPos[3*C+2]=(6371.25+satCache[C].alt)*u;satVel[3*C]=0,satVel[3*C+1]=0,satVel[3*C+2]=0,g=null,f=null,u=null,S=null}else if(satCache[C].missile){if(!satCache[C].active)continue;for(V=satCache[C].altList.length,E=0;E<V;E++)if(satCache[C].startTime+1e3*E>e){P=E;break}g=Math.cos(satCache[C].latList[P]*DEG2RAD),u=Math.sin(satCache[C].latList[P]*DEG2RAD),f=Math.cos(satCache[C].lonList[P]*DEG2RAD+a),S=Math.sin(satCache[C].lonList[P]*DEG2RAD+a),satPos[3*C]=(6371+satCache[C].altList[P])*g*f,satPos[3*C+1]=(6371+satCache[C].altList[P])*g*S,satPos[3*C+2]=(6371+satCache[C].altList[P])*u,P=Math.min(P,V),g=Math.cos(satCache[C].latList[P+1]*DEG2RAD),u=Math.sin(satCache[C].latList[P+1]*DEG2RAD),f=Math.cos(satCache[C].lonList[P+1]*DEG2RAD+o),S=Math.sin(satCache[C].lonList[P+1]*DEG2RAD+o),satVel[3*C]=(6371+satCache[C].altList[P+1])*g*f-satPos[3*C],satVel[3*C+1]=(6371+satCache[C].altList[P+1])*g*S-satPos[3*C+1],satVel[3*C+2]=(6371+satCache[C].altList[P+1])*u-satPos[3*C+2],b=satPos[3*C],d=satPos[3*C+1],h=satPos[3*C+2],g=null,f=null,u=null,S=null,r=satellite.eciToEcf({x:b,y:d,z:h},a),satellite.eciToGeodetic({x:b,y:d,z:h},a).height<=150&&!1===satellite.missile&&(console.error(satellite.SCC_NUM),satCache[C].skip=!0),l=(i=satellite.ecfToLookAngles(sensor.observerGd,r)).azimuth,c=i.elevation,m=i.rangeSat,l*=RAD2DEG,c*=RAD2DEG,satInView[C]=!1,sensor.obsminaz>sensor.obsmaxaz?(l>=sensor.obsminaz||l<=sensor.obsmaxaz)&&c>=sensor.obsminel&&c<=sensor.obsmaxel&&m<=sensor.obsmaxrange&&m>=sensor.obsminrange||(l>=sensor.obsminaz2||l<=sensor.obsmaxaz2)&&c>=sensor.obsminel2&&c<=sensor.obsmaxel2&&m<=sensor.obsmaxrange2&&m>=sensor.obsminrange2?satInView[C]=!0:satInView[C]=!1:l>=sensor.obsminaz&&l<=sensor.obsmaxaz&&c>=sensor.obsminel&&c<=sensor.obsmaxel&&m<=sensor.obsmaxrange&&m>=sensor.obsminrange||l>=sensor.obsminaz2&&l<=sensor.obsmaxaz2&&c>=sensor.obsminel2&&c<=sensor.obsmaxel2&&m<=sensor.obsmaxrange2&&m>=sensor.obsminrange2?satInView[C]=!0:satInView[C]=!1}else if(isShowFOVBubble||isResetFOVBubble){for(isMultiSensor||sensor.observerGd===defaultGd||(mSensor[0]=sensor,mSensor.length=1),sensorMarkerArray=[],M=0;M<mSensor.length;M++)if(sensorMarkerArray.push(C),(sensor=mSensor[M]).observerGd={longitude:sensor.long*DEG2RAD,latitude:sensor.lat*DEG2RAD,height:1*sensor.obshei},satCache[C].marker){if(satPos[3*C]=0,satPos[3*C+1]=0,satPos[3*C+2]=0,satVel[3*C]=0,satVel[3*C+1]=0,satVel[3*C+2]=0,isResetFOVBubble)continue;if(!isShowFOVBubble)continue;if(sensor.observerGd===sensor.defaultGd)continue;if(isIgnoreNonRadar){if(mSensor.length>1&&"Optical"===sensor.type)continue;if(mSensor.length>1&&"Mechanical"===sensor.type)continue}if(R=20,!isShowSurvFence||sensor.volume)if(console.log(sensor),0!==sensor.obsminaz&&360!==sensor.obsmaxaz){for(A=Math.max(sensor.obsminrange,100);A<Math.min(sensor.obsmaxrange,6e4);A+=Math.min(sensor.obsmaxrange,6e4)/30)for(G=sensor.obsminaz,z=sensor.obsminel;z<sensor.obsmaxel;z+=2)D=satellite.ecfToEci(_lookAnglesToEcf(G,z,A,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),satCache[C].active=!0,satPos[3*C]=D.x,satPos[3*C+1]=D.y,satPos[3*C+2]=D.z,satVel[3*C]=0,satVel[3*C+1]=0,satVel[3*C+2]=0,C++;for(A=Math.max(sensor.obsminrange,100);A<Math.min(sensor.obsmaxrange,6e4);A+=Math.min(sensor.obsmaxrange,6e4)/30)for(G=sensor.obsmaxaz,z=sensor.obsminel;z<sensor.obsmaxel;z+=2)D=satellite.ecfToEci(_lookAnglesToEcf(G,z,A,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),satCache[C].active=!0,satPos[3*C]=D.x,satPos[3*C+1]=D.y,satPos[3*C+2]=D.z,satVel[3*C]=0,satVel[3*C+1]=0,satVel[3*C+2]=0,C++;if(void 0!==sensor.obsminaz2){for(A=Math.max(sensor.obsminrange2,100);A<Math.min(sensor.obsmaxrange2,6e4);A+=Math.min(sensor.obsmaxrange2,6e4)/30)for(G=sensor.obsminaz2,z=sensor.obsminel2;z<sensor.obsmaxel2;z+=2)D=satellite.ecfToEci(_lookAnglesToEcf(G,z,A,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),satCache[C].active=!0,satPos[3*C]=D.x,satPos[3*C+1]=D.y,satPos[3*C+2]=D.z,satVel[3*C]=0,satVel[3*C+1]=0,satVel[3*C+2]=0,C++;for(A=Math.max(sensor.obsminrange2,100);A<Math.min(sensor.obsmaxrange2,6e4);A+=Math.min(sensor.obsmaxrange2,6e4)/30)for(G=sensor.obsmaxaz2,z=sensor.obsminel2;z<sensor.obsmaxel2;z+=2)D=satellite.ecfToEci(_lookAnglesToEcf(G,z,A,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),satCache[C].active=!0,satPos[3*C]=D.x,satPos[3*C+1]=D.y,satPos[3*C+2]=D.z,satVel[3*C]=0,satVel[3*C+1]=0,satVel[3*C+2]=0,C++}}else for(A=Math.max(sensor.obsminrange,100);A<Math.min(sensor.obsmaxrange,6e4);A+=Math.min(sensor.obsmaxrange,6e4)/30)for(z=sensor.obsmaxel,G=sensor.obsminaz;G<sensor.obsmaxaz;G+=2)D=satellite.ecfToEci(_lookAnglesToEcf(G,z,A,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),satCache[C].active=!0,satPos[3*C]=D.x,satPos[3*C+1]=D.y,satPos[3*C+2]=D.z,satVel[3*C]=0,satVel[3*C+1]=0,satVel[3*C+2]=0,C++;for(R=2,A=Math.max(sensor.obsminrange,100);A<Math.min(sensor.obsmaxrange,6e4);A+=Math.min(sensor.obsmaxrange,6e4)/30)for(G=0;G<360;G+=1*R){if(sensor.obsminaz>sensor.obsmaxaz){if(!(G>=sensor.obsminaz||G<=sensor.obsmaxaz))continue}else if(!(G>=sensor.obsminaz&&G<=sensor.obsmaxaz))continue;if(D=satellite.ecfToEci(_lookAnglesToEcf(G,sensor.obsminel,A,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),C===n){console.error("No More Markers");break}satCache[C].active=!0,satPos[3*C]=D.x,satPos[3*C+1]=D.y,satPos[3*C+2]=D.z,satVel[3*C]=0,satVel[3*C+1]=0,satVel[3*C+2]=0,C++}if(void 0!==sensor.obsminaz2)for(R=2,A=Math.max(sensor.obsminrange2,100);A<Math.min(sensor.obsmaxrange2,6e4);A+=Math.min(sensor.obsmaxrange2,6e4)/30)for(G=0;G<360;G+=1*R){if(sensor.obsminaz2>sensor.obsmaxaz2){if(!(G>=sensor.obsminaz2||G<=sensor.obsmaxaz2))continue}else if(!(G>=sensor.obsminaz2&&G<=sensor.obsmaxaz2))continue;if(D=satellite.ecfToEci(_lookAnglesToEcf(G,sensor.obsminel2,A,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),C===n){console.error("No More Markers");break}satCache[C].active=!0,satPos[3*C]=D.x,satPos[3*C+1]=D.y,satPos[3*C+2]=D.z,satVel[3*C]=0,satVel[3*C+1]=0,satVel[3*C+2]=0,C++}if(!isShowSurvFence||sensor.volume){for(A=Math.min(sensor.obsmaxrange,6e4),G=0;G<360;G+=2){if(sensor.obsminaz>sensor.obsmaxaz){if(!(G>=sensor.obsminaz||G<=sensor.obsmaxaz))continue}else if(!(G>=sensor.obsminaz&&G<=sensor.obsmaxaz))continue;for(z=sensor.obsminel;z<sensor.obsmaxel;z+=2){if(D=satellite.ecfToEci(_lookAnglesToEcf(G,z,A,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),C===n){console.error("No More Markers");break}satCache[C].active=!0,satPos[3*C]=D.x,satPos[3*C+1]=D.y,satPos[3*C+2]=D.z,satVel[3*C]=0,satVel[3*C+1]=0,satVel[3*C+2]=0,C++}}if(void 0!==sensor.obsminaz2)for(A=Math.min(sensor.obsmaxrange2,6e4),G=0;G<360;G+=2){if(sensor.obsminaz2>sensor.obsmaxaz2){if(!(G>=sensor.obsminaz2||G<=sensor.obsmaxaz2))continue}else if(!(G>=sensor.obsminaz2&&G<=sensor.obsmaxaz2))continue;for(z=sensor.obsminel2;z<sensor.obsmaxel2;z+=2){if(D=satellite.ecfToEci(_lookAnglesToEcf(G,z,A,sensor.observerGd.latitude,sensor.observerGd.longitude,sensor.observerGd.height),a),C===n){console.error("No More Markers");break}satCache[C].active=!0,satPos[3*C]=D.x,satPos[3*C+1]=D.y,satPos[3*C+2]=D.z,satVel[3*C]=0,satVel[3*C+1]=0,satVel[3*C+2]=0,C++}}}}}else if((isShowSatOverfly||isResetSatOverfly)&&satCache[C].marker){if(isResetSatOverfly&&!0===satCache[C].active){satCache[C].active=!1,satPos[3*C]=0,satPos[3*C+1]=0,satPos[3*C+2]=0,satVel[3*C]=0,satVel[3*C+1]=0,satVel[3*C+2]=0;continue}for(snum=0;snum<satelliteSelected.length;snum++)if(-1!==satelliteSelected[snum]){if(!isShowSatOverfly)continue;for(satSelPosX=satPos[3*satelliteSelected[snum]],satSelPosY=satPos[3*satelliteSelected[snum]+1],satSelPosZ=satPos[3*satelliteSelected[snum]+2],satSelPosEcf={x:satSelPosX,y:satSelPosY,z:satSelPosZ},satSelPos=satellite.ecfToEci(satSelPosEcf,a),satSelGeodetic=satellite.eciToGeodetic(satSelPos,a),satHeight=satSelGeodetic.height,satSelPosEarth={longitude:satSelGeodetic.longitude,latitude:satSelGeodetic.latitude,height:1},deltaLatInt=1,satHeight<2500&&selectedSatFOV<=60&&(deltaLatInt=.5),(satHeight>7e3||selectedSatFOV>=90)&&(deltaLatInt=2),satelliteSelected.length>1&&(deltaLatInt=2),deltaLat=-60;deltaLat<60;deltaLat+=deltaLatInt)if(lat=Math.max(Math.min(Math.round(satSelGeodetic.latitude*RAD2DEG)+deltaLat,90),-90)*DEG2RAD,!(lat>90))for(deltaLonInt=1,satHeight<2500&&selectedSatFOV<=60&&(deltaLonInt=.5),(satHeight>7e3||selectedSatFOV>=90)&&(deltaLonInt=2),satelliteSelected.length>1&&(deltaLonInt=2),deltaLon=0;deltaLon<181;deltaLon+=deltaLonInt){if(long=satSelGeodetic.longitude+deltaLon*DEG2RAD,satSelPosEarth={longitude:long,latitude:lat,height:15},(c=(i=satellite.ecfToLookAngles(satSelPosEarth,satSelPosEcf)).elevation)*RAD2DEG>0&&90-c*RAD2DEG<selectedSatFOV){if(satSelPosEarth=satellite.geodeticToEcf(satSelPosEarth),C===n){console.error("Ran out of Markers");continue}satCache[C].active=!0,satPos[3*C]=satSelPosEarth.x,satPos[3*C+1]=satSelPosEarth.y,satPos[3*C+2]=satSelPosEarth.z,satVel[3*C]=0,satVel[3*C+1]=0,satVel[3*C+2]=0,C++}if(0!==deltaLon&&180!==deltaLon){if(long=satSelGeodetic.longitude-deltaLon*DEG2RAD,satSelPosEarth={longitude:long,latitude:lat,height:15},(c=(i=satellite.ecfToLookAngles(satSelPosEarth,satSelPosEcf)).elevation)*RAD2DEG>0&&90-c*RAD2DEG<selectedSatFOV){if(satSelPosEarth=satellite.geodeticToEcf(satSelPosEarth),C===n){console.error("Ran out of Markers");continue}satCache[C].active=!0,satPos[3*C]=satSelPosEarth.x,satPos[3*C+1]=satSelPosEarth.y,satPos[3*C+2]=satSelPosEarth.z,satVel[3*C]=0,satVel[3*C+1]=0,satVel[3*C+2]=0,C++}if(90===lat||-90===lat)break}}}}if(isResetSatOverfly=!1,satCache[C].marker)for(;C<n;C++){if(!satCache[C].active){n-=fieldOfViewSetLength;break}satPos[3*C]=0,satPos[3*C+1]=0,satPos[3*C+2]=0,satVel[3*C]=0,satVel[3*C+1]=0,satVel[3*C+2]=0,satCache[C].active=!1}}isResetFOVBubble&&(isResetFOVBubble=!1,n-=fieldOfViewSetLength),postMessage({satPos:satPos.buffer,satVel:satVel.buffer,satInView:satInView.buffer,sensorMarkerArray:sensorMarkerArray}),setTimeout(propagateCruncher,1*globalPropagationRate*globalPropagationRateMultiplier/divisor)}function jday(e,s,a,t,o,n){"use strict";return 367*e-Math.floor(7*(e+Math.floor((s+9)/12))*.25)+Math.floor(275*s/9)+a+1721013.5+((n/60+o)/60+t)/24}function propTime(){"use strict";var e=new Date,s=(Number(e)-Number(propRealTime))*propRate;return e.setTime(Number(propRealTime)+propOffset+s),e}onmessage=function(e){switch(propRealTime=Date.now(),e.data.planetariumView&&(planetariumView=!0),e.data.nonPlanetariumView&&(planetariumView=!1),e.data.satelliteSelected&&-1===(satelliteSelected=e.data.satelliteSelected)[0]&&(isResetSatOverfly=!0),e.data.isSlowCPUModeEnabled&&(globalPropagationRateMultiplier=2),e.data.isLowPerf&&(isLowPerf=!0),e.data.fieldOfViewSetLength&&(fieldOfViewSetLength=e.data.fieldOfViewSetLength),"enable"===e.data.isShowSatOverfly&&(isShowSatOverfly=!0,selectedSatFOV=e.data.selectedSatFOV),"reset"===e.data.isShowSatOverfly&&(isResetSatOverfly=!0,isShowSatOverfly=!1),"enable"===e.data.isShowFOVBubble&&(isShowFOVBubble=!0),"reset"===e.data.isShowFOVBubble&&(isResetFOVBubble=!0,isShowFOVBubble=!1),"enable"===e.data.isShowSurvFence&&(isShowSurvFence=!0),"disable"===e.data.isShowSurvFence&&(isShowSurvFence=!1),e.data.multiSensor?(isMultiSensor=!0,mSensor=e.data.sensor,sensor=e.data.sensor,globalPropagationRate=2e3):e.data.sensor&&(sensor=e.data.sensor,e.data.setlatlong&&(e.data.resetObserverGd?(globalPropagationRate=1e3,sensor.observerGd=defaultGd,mSensor={}):(globalPropagationRate=2e3,sensor.observerGd={longitude:e.data.sensor.long*DEG2RAD,latitude:e.data.sensor.lat*DEG2RAD,height:1*e.data.sensor.obshei})),isMultiSensor=!1),e.data.typ){case"offset":return propOffset=Number(e.data.dat.split(" ")[0]),propRate=Number(e.data.dat.split(" ")[1]),void(divisor=Math.max(propRate,.1));case"satdata":var s=JSON.parse(e.data.dat);len=s.length;for(var a,t=0,o=[],n={};t<len;)n={},a=null,s[t].static||s[t].missile?(a=s[t],o.push(n),satCache.push(a),t++):(a=satellite.twoline2satrec(s[t].TLE1,s[t].TLE2),n.inclination=a.inclo,n.eccentricity=a.ecco,n.raan=a.nodeo,n.argPe=a.argpo,n.meanMotion=60*a.no*24/TAU,n.semiMajorAxis=Math.pow(8681663.653/n.meanMotion,2/3),n.semiMinorAxis=n.semiMajorAxis*Math.sqrt(1-Math.pow(n.eccentricity,2)),n.apogee=n.semiMajorAxis*(1+n.eccentricity)-RADIUS_OF_EARTH,n.perigee=n.semiMajorAxis*(1-n.eccentricity)-RADIUS_OF_EARTH,n.period=1440/n.meanMotion,o.push(n),satCache.push(a),t++);satPos=new Float32Array(3*len),satVel=new Float32Array(3*len),satInView=new Int8Array(len),postMessage({extraData:JSON.stringify(o)}),s=null;break;case"satEdit":satCache[e.data.id]=satellite.twoline2satrec(e.data.TLE1,e.data.TLE2),a=satCache[e.data.id],o=[],(n={}).inclination=a.inclo,n.eccentricity=a.ecco,n.raan=a.nodeo,n.argPe=a.argpo,n.meanMotion=60*a.no*24/(2*Math.PI),n.semiMajorAxis=Math.pow(8681663.653/n.meanMotion,2/3),n.semiMinorAxis=n.semiMajorAxis*Math.sqrt(1-Math.pow(n.eccentricity,2)),n.apogee=n.semiMajorAxis*(1+n.eccentricity)-RADIUS_OF_EARTH,n.perigee=n.semiMajorAxis*(1-n.eccentricity)-RADIUS_OF_EARTH,n.period=1440/n.meanMotion,n.TLE1=e.data.TLE1,n.TLE2=e.data.TLE2,o.push(n),postMessage({extraUpdate:!0,extraData:JSON.stringify(o),satId:e.data.id});break;case"newMissile":satCache[e.data.id]=e.data}propagationRunning||(len=-1,propagateCruncher())};var StarCalc={},PI=Math.PI,sin=Math.sin,cos=Math.cos,tan=Math.tan,asin=Math.asin,atan=Math.atan2,acos=Math.acos,rad=PI/180,dayMs=864e5,J1970=2440588,J2000=2451545;function toJulian(e){return e.valueOf()/dayMs-.5+J1970}function toDays(e){return toJulian(e)-J2000}function getAzimuth(e,s,a){return atan(sin(e),cos(e)*sin(s)-tan(a)*cos(s))}function getAltitude(e,s,a){return asin(sin(s)*sin(a)+cos(s)*cos(a)*cos(e))}function getSiderealTime(e,s){return rad*(280.16+360.9856235*e)-s}StarCalc.getStarPosition=function(e,s,a,t){var o=rad*-a,n=rad*s,r=getSiderealTime(toDays(e),o)-t.ra/12*Math.PI,i=getAltitude(r,n,t.dec/180*Math.PI);return i+=.017*rad/tan(i+10.26*rad/(i+5.1*rad)),{azimuth:getAzimuth(r,n,t.dec/180*Math.PI),altitude:i,vmag:t.vmag,name:t.name,pname:t.pname,dist:t.dist}};
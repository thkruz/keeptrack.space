import { UiManager } from '@app/app/ui/ui-manager';
import { Camera, CameraType } from '@app/engine/camera/camera';
import { Container } from '@app/engine/core/container';
import { Singletons, ToastMsgType } from '@app/engine/core/interfaces';
import { PluginRegistry } from '@app/engine/core/plugin-registry';
import { ServiceLocator } from '@app/engine/core/service-locator';
import { EventBus } from '@app/engine/events/event-bus';
import { EventBusEvent } from '@app/engine/events/event-bus-events';
import { getEl } from '@app/engine/utils/get-el';
import { t7e } from '@app/locales/keys';
import { SatelliteViewPlugin } from '@app/plugins/satellite-view/satellite-view';
import { SelectSatManager } from '@app/plugins/select-sat-manager/select-sat-manager';
import { mockCameraManager, mockUiManager } from './environment/standard-env';
import { standardPluginSuite } from './generic-tests';

// Generated by CodiumAI

/*
 *Code Analysis
 *
 *Main functionalities:
 *The SatelliteViewPlugin class is a plugin for the KeepTrack application that adds a satellite view feature. It allows the user to switch between a normal camera mode and a
 *satellite camera mode, where the camera is fixed to a selected satellite. The plugin adds an icon to the bottom menu that toggles the satellite view mode on and off. The plugin
 *also registers callbacks with the KeepTrack API to handle user interactions and add HTML and JS to the application.
 *
 *Methods:
 *- init(): initializes the plugin by adding HTML and JS
 *- addJs(): adds JS to the application by registering a callback with the KeepTrack API
 *- addHtml(): adds HTML to the application by registering a callback with the KeepTrack API
 *
 */

describe('SatelliteViewPlugin_class', () => {
  let selectSatManagerInstance: SelectSatManager;

  beforeEach(() => {
    PluginRegistry.unregisterAllPlugins();

    mockUiManager.toast = jest.fn();
    Container.getInstance().registerSingleton<UiManager>(Singletons.UiManager, mockUiManager);
    const selectSatManager = new SelectSatManager();

    selectSatManager.init();

    selectSatManagerInstance = PluginRegistry.getPlugin(SelectSatManager) as SelectSatManager;

    expect(selectSatManagerInstance).toBeDefined();
    expect(selectSatManagerInstance).not.toBeNull();

    if (!selectSatManagerInstance) {
      throw new Error('SelectSatManager is null');
    }
  });

  standardPluginSuite(SatelliteViewPlugin, 'SatelliteViewPlugin');

  // Tests that the addHtml method adds the correct HTML element to the DOM
  it('test_addHtml_method', () => {
    const plugin = new SatelliteViewPlugin();
    const registerSpy = jest.spyOn(EventBus.getInstance(), 'on');

    plugin.addHtml();
    EventBus.getInstance().emit(EventBusEvent.uiManagerInit);
    EventBus.getInstance().emit(EventBusEvent.uiManagerFinal);
    expect(registerSpy).toHaveBeenCalled();
    expect(getEl('bottom-icons')?.innerHTML).toContain('satellite-view-bottom-icon');
  });

  // Tests that a toast message is displayed when no satellite is selected and trying to activate Satellite Camera Mode
  it('test_bottomMenuClick_callback_no_satellite_selected', () => {
    const plugin = new SatelliteViewPlugin();
    const uiManagerInstance = ServiceLocator.getUiManager();

    selectSatManagerInstance.selectedSat = -1;
    plugin.init();
    EventBus.getInstance().emit(EventBusEvent.uiManagerInit);
    EventBus.getInstance().emit(EventBusEvent.uiManagerFinal);
    Container.getInstance().registerSingleton<Camera>(Singletons.MainCamera, mockCameraManager);
    EventBus.getInstance().emit(EventBusEvent.bottomMenuClick, plugin.bottomIconElementName);
    expect(uiManagerInstance.toast).toHaveBeenCalledWith(t7e('errorMsgs.SelectSatelliteFirst'), ToastMsgType.serious, true);
  });

  // Tests that a toast message is not displayed when a satellite is selected and trying to activate Satellite Camera Mode
  it('test_bottomMenuClick_callback_satellite_selected', () => {
    const plugin = new SatelliteViewPlugin();
    const uiManagerInstance = ServiceLocator.getUiManager();

    selectSatManagerInstance.selectedSat = 1;
    plugin.init();
    EventBus.getInstance().emit(EventBusEvent.uiManagerInit);
    EventBus.getInstance().emit(EventBusEvent.uiManagerFinal);
    Container.getInstance().registerSingleton<Camera>(Singletons.MainCamera, mockCameraManager);
    EventBus.getInstance().emit(EventBusEvent.bottomMenuClick, plugin.bottomIconElementName);
    expect(uiManagerInstance.toast).not.toHaveBeenCalled();
  });

  // Tests that clicking the Satellite Camera Mode icon switches the camera to Satellite mode
  it('should_switch_to_satellite_camera_mode_when_icon_clicked', () => {
    const plugin = new SatelliteViewPlugin();
    const uiManagerInstance = ServiceLocator.getUiManager();

    selectSatManagerInstance.selectedSat = 1;
    plugin.init();
    EventBus.getInstance().emit(EventBusEvent.uiManagerInit);
    EventBus.getInstance().emit(EventBusEvent.uiManagerFinal);
    const tempMockCamera = { ...mockCameraManager, cameraType: CameraType.SATELLITE } as Camera;

    Container.getInstance().registerSingleton<Camera>(Singletons.MainCamera, tempMockCamera);
    EventBus.getInstance().emit(EventBusEvent.bottomMenuClick, plugin.bottomIconElementName);
    expect(uiManagerInstance.toast).not.toHaveBeenCalled();
  });
});
